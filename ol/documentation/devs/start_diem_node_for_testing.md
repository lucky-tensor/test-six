# Start a diem node for testing

We have shared configs for starting a libra-node network that is always the same. See  `./0L_dev_config/` in the repo. 

NOTE: YOU MUST GENERATE A NEW GENESIS.BLOB IF YOU ARE CHANGING MOVE CODE and using this to test interactively. See below.

Step 1 (Optional):
Build whole project. You may need to do this if the .move code has changed, so that the genesis.blob is correct.
TODO: Faster way than compiling everything?
```
cargo build --all --bins --exclude cluster-test
```

Step 2:
Start network:
Note: make sure that all config files generated by `diem-swarm` are kept in config directory.

```
cargo run -p diem-node -- --config ./0L_dev_config/node.config.toml
```

If successful you will see some logs like:

```
Using node config NodeConfig { admission_control: AdmissionControlConfig { address: V4(0.0.0.0:57989), need_to_check_mempool_before_validation: false, max_concurrent_inbound_syncs: 100, upstream_proxy_timeout: 1s }, rpc: RpcConfig { address: V4(0.0.0.0:58001) }, base: BaseConfig { data_dir: "/tmp/424eae01f12445fbab8b042705ac4daf/0", role: Validator, waypoint: FromConfig { waypoint: Waypoint { version: 0, value: HashValue(640ecacfd2447c0b4a44f0bcf596585cf0dec3c2a6ca77b73f5f98e80fbb0d08) } } }, consensus: ConsensusConfig { max_block_size: 1000, contiguous_rounds: 2, max_pruned_blocks_in_mem: 10000, round_initial_timeout_ms: 1000, proposer_type: LeaderReputation(LeaderReputationConfig { active_weights: 99, inactive_weights: 1 }), safety_rules: SafetyRulesConfig { backend: InMemoryStorage, service: Thread } }, debug_interface: DebugInterfaceConfig { admission_control_node_debug_port: 57991, metrics_server_port: 57993, public_metrics_server_port: 57995, address: "0.0.0.0" }, execution: ExecutionConfig { genesis: Some(...), genesis_file_location: "genesis.blob" }Thread, full_node_networks: [], logger: LoggerConfig { is_async: true, chan_size: 256, level: Info }, metrics: MetricsConfig { collection_interval_ms: 1000, dir: "metrics", enabled: false, data_dir: "/tmp/424eae01f12445fbab8b042705ac4daf/0" }, mempool: MempoolConfig { broadcast_transactions: true, shared_mempool_tick_interval_ms: 50, shared_mempool_batch_size: 100, shared_mempool_max_concurrent_inbound_syncs: 100, shared_mempool_min_broadcast_recipient_count: None, max_broadcasts_per_peer: 25, capacity: 1000000, capacity_per_user: 100, system_transaction_timeout_secs: 86400, system_transaction_gc_interval_ms: 180000 }, state_sync: StateSyncConfig { chunk_limit: 250, tick_interval_ms: 100, long_poll_timeout_ms: 30000, max_chunk_limit: 1000, max_timeout_ms: 120000, sync_request_timeout_ms: 60000 }, storage: StorageConfig { address: V4(127.0.0.1:57997), backup_service_port: 57999, dir: "libradb/db", grpc_max_receive_len: Some(100000000), prune_window: None, data_dir: "/tmp/424eae01f12445fbab8b042705ac4daf/0" }, test: Some(TestConfig { auth_key: Some(AuthenticationKey([23, 150, 130, 76, 220, 195, 171, 32, 92, 37, 242, 96, 225, 93, 198, 112, 89, 66, 211, 86, 241, 20, 8, 157, 74, 70, 242, 243, 176, 177, 91, 82])), operator_keypair: Some(KeyPair { private_key: Some(<elided secret for Ed25519PrivateKey>), public_key: Ed25519PublicKey(1a3201a76a32a948bb8b89496d137243df86fddcbac2bec67baaf78a5a36d3d1) }), consensus_keypair: Some(KeyPair { private_key: Some(<elided secret for Ed25519PrivateKey>), public_key: Ed25519PublicKey(7e3c4c48f406240433b116ee1566d19570b4e2a65d8a4264a1f1835715392ca2) }), initialize_storage: true, temp_dir: None, publishing_option: None }), upstream: UpstreamConfig { primary_networks: [5942d356f114089d4a46f2f3b0b15b52], upstream_peers: {}, fallback_networks: [] }, validator_network: Some(NetworkConfig { listen_address: /ip4/0.0.0.0/tcp/58003, advertised_address: /ip4/0.0.0.0/tcp/58003, discovery_interval_ms: 1000, connectivity_check_interval_ms: 5000, enable_remote_authentication: true, discovery_method: Gossip, network_peers: <0 keys>, network_peers_file: "", seed_peers: SeedPeersConfig { seed_peers: {5942d356f114089d4a46f2f3b0b15b52: [/ip4/0.0.0.0/tcp/58003/ln-noise-ik/bc9e1e478585fa19da7e09de7031d1836357969f9807f58c954a4b8c84ed9a77/ln-handshake/0]} }, seed_peers_file: "5942d356f114089d4a46f2f3b0b15b52.seed_peers.toml", identity: FromConfig(IdentityFromConfig { keypair: KeyPair { private_key: Some(<elided secret for PrivateKey>), public_key: [X25519 public key: bc9e1e478585fa19da7e09de7031d1836357969f9807f58c954a4b8c84ed9a77] }, peer_id: 5942d356f114089d4a46f2f3b0b15b52 }), network_id: Validator }) }
```

Step 3. (optional) Connect with shell
You can now connect to this node in another terminal with these parameters:
Note: if you regenerate the files in 0L_dev_config, you should update this string (and this wiki please).

```
cargo run -p cli -- -u http://localhost:63845 -m "0L_dev_config/mint.key" --waypoint 0:8859e663dfc13a44d2b67b11bfa4bf7679c61691de5fb0c483c4874b4edae35b
```

## Generate new genesis.blob and config files

The configs stored in 0L_dev_config were generated like this:

Step 1:
Generate config files with the test helper, libra-swarm. Us `cargo run` with -c  <path_to_save_configs> so that it outputs the config files from swarm for saving.

```
#in project root
cargo run -p diem-swarm -- -l -c ./0L_dev_config/temp
```
This will create files in 0L_dev_configs/temp. Now move the ones we care about one level up and delete /temp/

```
.
├── 5942d356f114089d4a46f2f3b0b15b52.seed_peers.toml
├── genesis.blob
├── mint.key
└── node.config.toml
```

Keep these files and discard the /logs/ and libradb/ (which should not be committed to project under /0_dev_config/)
NOTE! Genesis.blob should be regenerated every time there is a change to the .move code.
